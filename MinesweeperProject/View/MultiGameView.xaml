<UserControl x:Class="MinesweeperProject.View.MultiGameView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:local="clr-namespace:MinesweeperProject.View"
             mc:Ignorable="d"
             Background="White">

    <UserControl.Resources>
        <Storyboard x:Key="FadeInVictoryOverlay" x:Shared="False">
            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                             From="0" To="1" Duration="0:0:0.8"/>
        </Storyboard>

        <Storyboard x:Key="FadeInDefeatOverlay" x:Shared="False">
            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                     From="0" To="1" Duration="0:0:0.8"/>
        </Storyboard>

        <Storyboard x:Key="ScaleVictoryText" x:Shared="False">
            <DoubleAnimation Storyboard.TargetProperty="(RenderTransform).ScaleX"
                             From="0" To="1" Duration="0:0:1">
                <DoubleAnimation.EasingFunction>
                    <ElasticEase Oscillations="2" Springiness="5"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation Storyboard.TargetProperty="(RenderTransform).ScaleY"
                             From="0" To="1" Duration="0:0:1">
                <DoubleAnimation.EasingFunction>
                    <ElasticEase Oscillations="2" Springiness="5"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>

        <Storyboard x:Key="ScaleDefeatText" x:Shared="False">
            <DoubleAnimation Storyboard.TargetProperty="(RenderTransform).ScaleX"
                         From="0" To="1" Duration="0:0:1">
                <DoubleAnimation.EasingFunction>
                    <ElasticEase Oscillations="2" Springiness="5"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation Storyboard.TargetProperty="(RenderTransform).ScaleY"
                         From="0" To="1" Duration="0:0:1">
                <DoubleAnimation.EasingFunction>
                    <ElasticEase Oscillations="2" Springiness="5"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
        </Storyboard>

        <!-- 셀 버튼 공통 스타일 -->
        <Style x:Key="CellButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="LightGray"/>
            <Setter Property="FontSize" Value="16"/>
            <Setter Property="FontWeight" Value="Bold"/>

            <Style.Triggers>
                <!-- 열림: 기본적으로 숫자 표시 -->
                <DataTrigger Binding="{Binding IsOpened}" Value="True">
                    <Setter Property="Background" Value="White"/>
                    <Setter Property="IsEnabled" Value="False"/>
                    <Setter Property="Content" Value="{Binding NeighborMineCount}"/>
                </DataTrigger>

                <!-- 0이면 빈칸 -->
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding IsOpened}" Value="True"/>
                        <Condition Binding="{Binding NeighborMineCount}" Value="0"/>
                        <Condition Binding="{Binding IsMine}" Value="False"/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Content" Value=""/>
                </MultiDataTrigger>

                <!-- 깃발 -->
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding IsOpened}" Value="False"/>
                        <Condition Binding="{Binding IsFlagged}" Value="True"/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Content" Value="🚩"/>
                    <Setter Property="Foreground" Value="Red"/>
                </MultiDataTrigger>

                <!-- 숫자 색 -->
                <DataTrigger Binding="{Binding NeighborMineCount}" Value="1">
                    <Setter Property="Foreground" Value="Blue"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding NeighborMineCount}" Value="2">
                    <Setter Property="Foreground" Value="Green"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding NeighborMineCount}" Value="3">
                    <Setter Property="Foreground" Value="Red"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding NeighborMineCount}" Value="4">
                    <Setter Property="Foreground" Value="DarkBlue"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding NeighborMineCount}" Value="5">
                    <Setter Property="Foreground" Value="Maroon"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding NeighborMineCount}" Value="6">
                    <Setter Property="Foreground" Value="Teal"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding NeighborMineCount}" Value="7">
                    <Setter Property="Foreground" Value="Black"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding NeighborMineCount}" Value="8">
                    <Setter Property="Foreground" Value="Gray"/>
                </DataTrigger>

                <!-- 지뢰 표시 -->
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding IsOpened}" Value="True"/>
                        <Condition Binding="{Binding IsMine}" Value="True"/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Content" Value="💣"/>
                    <Setter Property="Background" Value="Black"/>
                </MultiDataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <DockPanel>
        <!-- 상단 바 -->
        <Border DockPanel.Dock="Top" Background="#EEEEEE" Height="50" Padding="10">
            <Grid>
                <Button Content="나가기"
                        Command="{Binding ReturnToMenuCommand}"
                        HorizontalAlignment="Left" Width="60"/>

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                    <TextBlock Text="💣 " VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding MineCount}"
                               FontWeight="Bold"
                               VerticalAlignment="Center"
                               Margin="0,0,30,0"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 본문: 좌(내) / 가운데 간격 / 우(상대) -->
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="30"/>
                <!-- ✅ 보드 사이 간격 -->
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- 왼쪽: 내 보드 -->
            <Grid Grid.Column="0" Margin="0,0,10,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- ✅ 제목: 보드 가로 중앙 -->
                <TextBlock Grid.Row="0"
                           Text="내 보드"
                           FontWeight="Bold"
                           Margin="10,10,10,5"
                           HorizontalAlignment="Center"
                           TextAlignment="Center"/>

                <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding Cells}" UseLayoutRounding="True">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Rows="{Binding Rows}" Columns="{Binding Cols}"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Width="30" Height="30" Margin="0" Padding="0"
                                        BorderThickness="1" BorderBrush="#AAAAAA"
                                        Style="{StaticResource CellButtonStyle}"
                                        Command="{Binding DataContext.OpenCellCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                        CommandParameter="{Binding}">
                                    <Button.InputBindings>
                                        <MouseBinding MouseAction="RightClick"
                                                      Command="{Binding DataContext.FlagCellCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                                      CommandParameter="{Binding}"/>
                                    </Button.InputBindings>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>

            <!-- 가운데: 간격(원하면 구분선도 가능) -->
            <Border Grid.Column="1" Background="Transparent">
                <!-- 구분선 원하면 아래 주석 해제 -->
                <!-- <Border BorderBrush="#DDDDDD" BorderThickness="1,0,1,0"/> -->
            </Border>

            <!-- 오른쪽: 상대 보드 -->
            <Grid Grid.Column="2" Margin="10,0,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- ✅ 제목: 보드 가로 중앙 -->
                <TextBlock Grid.Row="0"
                           Text="상대 보드"
                           FontWeight="Bold"
                           Margin="10,10,10,5"
                           HorizontalAlignment="Center"
                           TextAlignment="Center"/>

                <ScrollViewer Grid.Row="1" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                    <ItemsControl ItemsSource="{Binding RemoteCells}" UseLayoutRounding="True">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Rows="{Binding RemoteRows}" Columns="{Binding RemoteCols}"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Width="30" Height="30" Margin="0" Padding="0"
                                        BorderThickness="1" BorderBrush="#AAAAAA"
                                        Style="{StaticResource CellButtonStyle}"
                                        IsHitTestVisible="False"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>

            <!-- 승리 오버레이: 좌우 전체 덮기 -->
            <Grid x:Name="VictoryOverlay" Grid.ColumnSpan="3" Opacity="0" IsHitTestVisible="False">
                <Grid.Style>
                    <Style TargetType="Grid">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsGameWon}" Value="True">
                                <DataTrigger.EnterActions>
                                    <BeginStoryboard Storyboard="{StaticResource FadeInVictoryOverlay}"/>
                                </DataTrigger.EnterActions>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Grid.Style>

                <Rectangle Fill="Black" Opacity="0.5"/>

                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <TextBlock x:Name="VictoryText" Text="VICTORY!"
                               FontSize="72" FontWeight="ExtraBold" Foreground="Gold">
                        <TextBlock.RenderTransform>
                            <ScaleTransform CenterX="150" CenterY="50" ScaleX="0" ScaleY="0"/>
                        </TextBlock.RenderTransform>

                        <TextBlock.Effect>
                            <DropShadowEffect Color="Orange" BlurRadius="20" ShadowDepth="0"/>
                        </TextBlock.Effect>

                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsGameWon}" Value="True">
                                        <DataTrigger.EnterActions>
                                            <BeginStoryboard Storyboard="{StaticResource ScaleVictoryText}"/>
                                        </DataTrigger.EnterActions>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </StackPanel>
            </Grid>
            <!-- 패배 오버레이 -->
            <Grid x:Name="DefeatOverlay" Grid.ColumnSpan="3" Opacity="0" IsHitTestVisible="False">
                <Grid.Style>
                    <Style TargetType="Grid">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsRemoteGameWon}" Value="True">
                                <DataTrigger.EnterActions>
                                    <BeginStoryboard Storyboard="{StaticResource FadeInDefeatOverlay}"/>
                                </DataTrigger.EnterActions>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </Grid.Style>

                <Rectangle Fill="Black" Opacity="0.5"/>

                <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                    <TextBlock x:Name="DefeatText" Text="DEFEAT..."
                   FontSize="72" FontWeight="ExtraBold" Foreground="Tomato">
                        <TextBlock.RenderTransform>
                            <ScaleTransform CenterX="150" CenterY="50" ScaleX="0" ScaleY="0"/>
                        </TextBlock.RenderTransform>

                        <TextBlock.Effect>
                            <DropShadowEffect Color="Black" BlurRadius="20" ShadowDepth="0"/>
                        </TextBlock.Effect>

                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsRemoteGameWon}" Value="True">
                                        <DataTrigger.EnterActions>
                                            <BeginStoryboard Storyboard="{StaticResource ScaleDefeatText}"/>
                                        </DataTrigger.EnterActions>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </StackPanel>
            </Grid>
        </Grid>
    </DockPanel>
</UserControl>
